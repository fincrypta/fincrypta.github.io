name: Auto Update Sitemap & Robots

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure .nojekyll exists
        run: echo "" > .nojekyll

      - name: Generate sitemap.xml
        run: |
          BASE_URL="https://fincrypta.github.io"

          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml

          add_url () {
            file="$1"
            url="$2"
            priority="$3"
            freq="$4"

            if [ -f "$file" ]; then
              lastmod=$(date -u -r "$file" +"%Y-%m-%dT%H:%M:%SZ")
              echo "  <url>" >> sitemap.xml
              echo "    <loc>${BASE_URL}/${url}</loc>" >> sitemap.xml
              echo "    <lastmod>$lastmod</lastmod>" >> sitemap.xml
              echo "    <changefreq>$freq</changefreq>" >> sitemap.xml
              echo "    <priority>$priority</priority>" >> sitemap.xml
              echo "  </url>" >> sitemap.xml
            fi
          }

          # Главная
          add_url "index.html" "" "1.0" "daily"

          # HTML в корне
          for f in *.html; do
            [[ "$f" != "index.html" ]] && add_url "$f" "$f" "0.8" "weekly"
          done

          # blog/*.html
          for f in blog/*.html; do
            add_url "$f" "$f" "0.9" "daily"
          done

          # blog/articles/*.html
          for f in blog/articles/*.html; do
            add_url "$f" "$f" "0.7" "weekly"
          done

          echo '</urlset>' >> sitemap.xml

      - name: Generate robots.txt
        run: |
          echo "User-agent: *" > robots.txt
          echo "Allow: /" >> robots.txt
          echo "Sitemap: https://fincrypta.github.io/sitemap.xml" >> robots.txt

      - name: Commit and Push changes
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add sitemap.xml robots.txt .nojekyll
          git commit -m "Auto-update sitemap and robots" || true
          git push

name: Auto Generate Sitemap & Robots

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure .nojekyll exists
        run: touch .nojekyll

      - name: Generate sitemap.xml
        shell: bash
        run: |
          BASE_URL="https://fincrypta.github.io"

          # URL-encoding + XML-escaping (оставляем /)
          urlencode() {
            local raw="$1"
            local len=${#raw}
            local encoded=""
            for (( i=0; i<len; i++ )); do
              c="${raw:$i:1}"
              case $c in
                [a-zA-Z0-9.~_-]|/) encoded+="$c" ;;
                *) printf -v hex '%%%02X' "'$c"; encoded+="$hex" ;;
              esac
            done
            echo "$encoded"
          }

          xmlescape() {
            echo "$1" \
              | sed -e 's/&/\&amp;/g' \
                    -e 's/</\&lt;/g' \
                    -e 's/>/\&gt;/g' \
                    -e "s/'/\&apos;/g" \
                    -e 's/"/\&quot;/g'
          }

          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml

          # ищем все html-файлы (включая вложенные)
          mapfile -t HTML_FILES < <(find . -type f -name "*.html" | sort)

          for file in "${HTML_FILES[@]}"; do
            clean="${file#./}"

            # главная отдельно
            if [[ "$clean" == "index.html" ]]; then
              url="${BASE_URL}/index.html"
            else
              encoded=$(urlencode "$clean")
              url="${BASE_URL}/${encoded}"
            fi

            esc_url=$(xmlescape "$url")
            lastmod=$(date -u -r "$file" +"%Y-%m-%dT%H:%M:%SZ")

            echo "  <url>" >> sitemap.xml
            echo "    <loc>${esc_url}</loc>" >> sitemap.xml
            echo "    <lastmod>${lastmod}</lastmod>" >> sitemap.xml
            echo "  </url>" >> sitemap.xml
          done

          echo '</urlset>' >> sitemap.xml

      - name: Generate robots.txt
        run: |
          echo "User-agent: *" > robots.txt
          echo "Allow: /" >> robots.txt
          echo "Sitemap: https://fincrypta.github.io/sitemap.xml" >> robots.txt

      - name: Commit and Push changes
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add sitemap.xml robots.txt .nojekyll
          git commit -m "Auto-generate sitemap.xml and robots.txt" || echo "No changes"
          git push
